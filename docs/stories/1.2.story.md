# Story 1.2: Legacy System Integration

## Status
❌ OBSOLETE - Replaced by Story 1.2R (Parquet/Arrow/cuDF Architecture)

## Obsolete Note
This story was designed for HeavyDB architecture which has been deprecated. All functionality needs to be reimplemented for the new Parquet/Arrow/cuDF architecture in Story 1.2R. This story is preserved for historical reference only.

**Original Design:**
- Legacy system integration with HeavyDB workflow
- Comparison against `csv_only_heavydb_workflow.py`
- Target fitness validation: SA algorithm ~30.458 for size 37

**See Story 1.2R for current implementation requirements**

## Story
**As a** System Developer,
**I want** to integrate the legacy optimizer system,
**so that** we can validate our new implementation against proven results and ensure fitness calculation parity

## Acceptance Criteria
1. Execute actual `Optimizer_New_patched.py`
2. Parse real optimization results
3. Validate fitness calculation parity

## Tasks / Subtasks
- [ ] Task 1: Set up legacy system execution wrapper (AC: 1)
  - [ ] Subtask 1.1: Create Python wrapper to execute `Optimizer_New_patched.py` from `/zone_optimization_25_06_25/`
  - [ ] Subtask 1.2: Handle command-line arguments and configuration for legacy system
  - [ ] Subtask 1.3: Capture stdout/stderr and handle potential execution errors
  - [ ] Subtask 1.4: Implement timeout mechanism for long-running optimizations
- [ ] Task 2: Implement legacy output parser (AC: 2)
  - [ ] Subtask 2.1: Parse `optimization_summary_*.txt` files for results
  - [ ] Subtask 2.2: Extract fitness scores, portfolio sizes, and selected strategies
  - [ ] Subtask 2.3: Parse algorithm performance data (GA, SA, PSO, etc.)
  - [ ] Subtask 2.4: Handle different output formats across portfolio sizes
- [ ] Task 3: Create fitness calculation validator (AC: 3)
  - [ ] Subtask 3.1: Compare legacy fitness values with new system calculations
  - [ ] Subtask 3.2: Implement tolerance threshold for acceptable variation (±0.01%)
  - [ ] Subtask 3.3: Generate comparison report showing differences
  - [ ] Subtask 3.4: Flag any significant deviations for investigation
- [ ] Task 4: Integration with new workflow
  - [ ] Subtask 4.1: Add legacy system execution option to main workflow
  - [ ] Subtask 4.2: Create side-by-side comparison mode
  - [ ] Subtask 4.3: Ensure same input data is used for both systems
  - [ ] Subtask 4.4: Document any behavioral differences discovered
- [ ] Task 5: Test with production data
  - [ ] Subtask 5.1: Run legacy system with `Python_Multi_Consolidated_20250726_161921.csv`
  - [ ] Subtask 5.2: Compare results for portfolio sizes 35-60
  - [ ] Subtask 5.3: Verify SA algorithm achieves fitness ~30.458 for size 37
  - [ ] Subtask 5.4: Document execution times and resource usage

## Dev Notes

### Previous Story Insights
From Story 1.1:
- Real algorithms now integrated and executing successfully
- Standardized fitness calculation implemented: `(roi / max_drawdown) * win_rate * np.log1p(profit_factor)`
- Simplified algorithm implementations created to avoid import issues
- Best performing algorithm is SA with fitness scores around 0.020-0.030

### Data Models
No new data models required. Legacy system uses same CSV input format and produces text/CSV outputs.

### API Specifications
No external APIs. Internal interfaces:
- Legacy executor: `execute_legacy_optimizer(input_file, portfolio_size, config_path)`
- Result parser: `parse_legacy_results(output_directory) -> Dict`
- Fitness validator: `validate_fitness_parity(legacy_fitness, new_fitness, tolerance=0.0001) -> bool`

### Component Specifications
**Legacy System Location** [Source: File system check]:
- Main script: `/zone_optimization_25_06_25/Optimizer_New_patched.py`
- Configuration files: `config_zone.ini`, `config_consol.ini`
- Output directory: `/zone_optimization_25_06_25/Output/run_*/`

**Legacy Output Format** [Source: optimization_summary_20250726_163251.txt]:
- Best fitness for size 37: 30.45764862187442 (SA algorithm)
- Output includes: optimization parameters, best portfolio details, selected strategies
- File naming: `optimization_summary_{timestamp}.txt`

### File Locations
- Legacy system: `/mnt/optimizer_share/zone_optimization_25_06_25/`
- New integration code: `/backend/legacy_system_integration.py`
- Comparison reports: `/output/legacy_comparison/`
- Test data: `/input/Python_Multi_Consolidated_20250726_161921.csv`

### Testing Requirements
- Execute legacy system with known inputs and verify outputs match historical results
- Compare fitness calculations between systems with tolerance of 0.01%
- Ensure legacy system execution doesn't interfere with new system
- Validate parsing of all output formats

### Technical Constraints
- Legacy system is monolithic and file-based [Source: docs/architecture.md#L16]
- Must maintain backward compatibility with CSV formats [Source: docs/architecture.md#L26]
- Core data flow (ULTA -> Correlation -> Algorithm) must be preserved [Source: docs/architecture.md#L27]
- Legacy system proven results: portfolio size 37, fitness 30.458, SA algorithm

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-07-31 | 1.0 | Initial story draft | Bob (SM) |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be filled by Dev Agent]

### Completion Notes List
[To be filled by Dev Agent]

### File List
[To be filled by Dev Agent]

## QA Results
[To be filled by QA Agent]