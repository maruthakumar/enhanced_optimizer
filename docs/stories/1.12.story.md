# Story 1.12: Configuration Management System

## Status
Draft

## Story
**As a** System Administrator,
**I want** a comprehensive configuration management system for CSV formats, regime optimization, and fitness calculation modes,
**so that** the platform can be easily configured for different use cases without code changes

## Acceptance Criteria
1. CSV_FORMAT configuration block implementation with auto-detection and validation
2. REGIME_OPTIMIZATION configuration with thresholds and weighting options
3. FITNESS_CALCULATION mode switching between legacy, enhanced, and hybrid modes
4. Configuration validation, defaults, inheritance, and hot-reload support

## Tasks / Subtasks

### Task 1: CSV Format Configuration (AC: 1)
- [ ] Subtask 1.1: Implement CSV_FORMAT configuration block
  - [ ] Create configuration schema as specified in PRD Section 3
  - [ ] Implement `format_detection = auto` with smart column detection
  - [ ] Support `legacy_support = true` for backward compatibility
  - [ ] Add `enhanced_columns` list management
- [ ] Subtask 1.2: Column detection and validation
  - [ ] Implement `strategy_pattern = auto_detect` logic
  - [ ] Identify mandatory columns (Date) vs enhanced vs strategy columns
  - [ ] Create column type validation (numeric for strategies)
  - [ ] Add custom column mapping support
- [ ] Subtask 1.3: Format flexibility features
  - [ ] Support `optional_columns = configurable`
  - [ ] Implement column inclusion/exclusion rules
  - [ ] Add format versioning for future changes
  - [ ] Create format migration utilities

### Task 2: Regime Optimization Configuration (AC: 2)
- [ ] Subtask 2.1: Implement REGIME_OPTIMIZATION block
  - [ ] Create configuration as specified in PRD Section 4
  - [ ] Implement `min_confidence_threshold = 70` with validation
  - [ ] Add `min_transition_threshold = 0.5` support
  - [ ] Enable `confidence_weighting = true` logic
- [ ] Subtask 2.2: Regime-specific features
  - [ ] Implement `regime_specific_portfolios = true`
  - [ ] Add per-regime parameter overrides
  - [ ] Create regime transition detection config
  - [ ] Support custom regime definitions
- [ ] Subtask 2.3: Advanced regime configuration
  - [ ] Add regime clustering parameters
  - [ ] Implement regime confidence decay settings
  - [ ] Create regime history window configuration
  - [ ] Support A/B testing for regime strategies

### Task 3: Fitness Calculation Modes (AC: 3)
- [ ] Subtask 3.1: Implement FITNESS_CALCULATION configuration
  - [ ] Create mode selection: `legacy|enhanced|hybrid`
  - [ ] Define `legacy_metrics = roi,dd,ratio`
  - [ ] Specify `enhanced_metrics = sharpe,sortino,calmar,kelly`
  - [ ] Implement mode switching logic
- [ ] Subtask 3.2: Mode-specific implementations
  - [ ] Legacy mode: `fitness = roi / max_drawdown - correlation_penalty`
  - [ ] Enhanced mode: `fitness = kelly_weight * sharpe * regime_factor - var_penalty`
  - [ ] Hybrid mode: Weighted combination of both
  - [ ] Add custom fitness formula support
- [ ] Subtask 3.3: Metric configuration
  - [ ] Configure metric weights and penalties
  - [ ] Add metric normalization options
  - [ ] Support metric aggregation methods
  - [ ] Enable metric-specific thresholds

### Task 4: Configuration Infrastructure (AC: 4)
- [ ] Subtask 4.1: Configuration file management
  - [ ] Implement hierarchical configuration (base → environment → job)
  - [ ] Support multiple formats (INI, JSON, YAML)
  - [ ] Add configuration inheritance and overrides
  - [ ] Create configuration templates
- [ ] Subtask 4.2: Validation framework
  - [ ] Implement schema validation for all blocks
  - [ ] Add type checking and range validation
  - [ ] Create dependency validation between settings
  - [ ] Generate validation reports
- [ ] Subtask 4.3: Dynamic configuration
  - [ ] Implement hot-reload without restart
  - [ ] Add configuration change notifications
  - [ ] Support runtime parameter updates
  - [ ] Create configuration versioning

### Task 5: Integration and Documentation
- [ ] Subtask 5.1: Platform integration
  - [ ] Update all components to use central configuration
  - [ ] Migrate hardcoded values to configuration
  - [ ] Add configuration injection to workflows
  - [ ] Create configuration facades for components
- [ ] Subtask 5.2: Configuration UI/CLI
  - [ ] Create configuration viewer/editor CLI
  - [ ] Add configuration validation command
  - [ ] Implement configuration diff tool
  - [ ] Support configuration export/import
- [ ] Subtask 5.3: Documentation and examples
  - [ ] Create comprehensive configuration guide
  - [ ] Add example configurations for common scenarios
  - [ ] Document all configuration parameters
  - [ ] Create migration guide from old configs

## Dev Notes

### Previous Story Context
This story provides the configuration foundation for all features implemented in Stories 1.1-1.11, centralizing configuration management as specified in PRD Sections 3-4 and Architecture Section 4.

### Configuration Schema Structure
```ini
# /config/production_config.ini
[CSV_FORMAT]
format_detection = auto
legacy_support = true
enhanced_columns = start_time,end_time,market_regime,capital,zone,Regime_Confidence_%,Market_regime_transition_threshold
mandatory_columns = Date
strategy_pattern = auto_detect
optional_columns = configurable

[REGIME_OPTIMIZATION]
min_confidence_threshold = 70
min_transition_threshold = 0.5
confidence_weighting = true
regime_specific_portfolios = true
regime_column = market_regime
confidence_column = Regime_Confidence_%

[FITNESS_CALCULATION]
mode = enhanced  # legacy|enhanced|hybrid
legacy_metrics = roi,dd,ratio
enhanced_metrics = sharpe,sortino,calmar,kelly
legacy_weight = 0.3  # For hybrid mode
enhanced_weight = 0.7  # For hybrid mode

[RISK_METRICS]
var_confidence_levels = 95,99
cvar_confidence_levels = 95,99
var_limit = 0.025
risk_free_rate = 0.02

[KELLY_CRITERION]
enabled = true
max_position_size = 0.25
min_position_size = 0.01
fallback_mode = equal_weight
```

### Configuration Manager Design
```python
class ConfigurationManager:
    def __init__(self, base_config_path: str):
        self.base_config = self.load_config(base_config_path)
        self.validators = self.setup_validators()
        self.watchers = []
        
    def get(self, section: str, key: str, default=None):
        # Hierarchical lookup with validation
        value = self.lookup_value(section, key, default)
        return self.validate_and_cast(section, key, value)
        
    def reload(self):
        # Hot-reload configuration
        new_config = self.load_config(self.base_config_path)
        changes = self.diff_configs(self.base_config, new_config)
        self.notify_watchers(changes)
        self.base_config = new_config
```

### Validation Rules
```python
VALIDATION_SCHEMA = {
    'CSV_FORMAT': {
        'format_detection': {'type': str, 'values': ['auto', 'manual']},
        'legacy_support': {'type': bool},
        'enhanced_columns': {'type': list, 'validator': validate_column_names}
    },
    'REGIME_OPTIMIZATION': {
        'min_confidence_threshold': {'type': float, 'range': (0, 100)},
        'min_transition_threshold': {'type': float, 'range': (0, 1)},
        'confidence_weighting': {'type': bool}
    },
    'FITNESS_CALCULATION': {
        'mode': {'type': str, 'values': ['legacy', 'enhanced', 'hybrid']},
        'legacy_weight': {'type': float, 'range': (0, 1), 'required_if': 'mode=hybrid'},
        'enhanced_weight': {'type': float, 'range': (0, 1), 'required_if': 'mode=hybrid'}
    }
}
```

### File Locations
**New Components:**
- Configuration manager: `/backend/lib/config/configuration_manager.py`
- Validators: `/backend/lib/config/validators.py`
- Schema definitions: `/backend/lib/config/schemas.py`
- Config templates: `/config/templates/`

**Configuration Files:**
- Base config: `/config/production_config.ini`
- Environment configs: `/config/environments/`
- Job-specific configs: `/config/jobs/`
- Default values: `/config/defaults.ini`

### Integration Points
- Main workflow: Update to use ConfigurationManager
- All algorithm classes: Inject configuration
- Output engine: Use configured metrics
- CSV loader: Apply format configuration

### Testing Requirements
- Validate all configuration combinations
- Test hot-reload functionality
- Verify validation catches invalid configs
- Test inheritance and override logic
- Validate backward compatibility

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-03 | 1.0 | Initial story creation for configuration management system | Claude Code |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be updated during implementation]

### Completion Notes List
[To be updated during implementation]

### File List
[To be updated during implementation]

## QA Results

### QA Review Summary
[To be completed by QA Agent after implementation]

### Acceptance Criteria Verification
[To be completed by QA Agent]

### Test Results
[To be completed by QA Agent]

### Code Quality Assessment
[To be completed by QA Agent]

### Issues Found
[To be completed by QA Agent]

### Compliance Check
[To be completed by QA Agent]

### Final QA Verdict
[To be completed by QA Agent]