# Story 1.6: Enhanced Financial Optimization

## Status
To Do

## Story
**As a** Portfolio Optimization System User,
**I want** enhanced financial metrics including Kelly Criterion, VaR/CVaR, Sharpe/Sortino ratios, and market regime optimization,
**so that** portfolio selection is optimized using professional-grade risk-adjusted metrics and capital allocation strategies

## Acceptance Criteria
1. Implement Kelly Criterion position sizing for optimal capital allocation based on win/loss probabilities
2. Add VaR/CVaR calculations with 95%/99% confidence levels for risk assessment
3. Integrate Sharpe, Sortino, and Calmar ratios for risk-adjusted return optimization
4. Implement market regime confidence weighting for strategy selection and position sizing

## Tasks / Subtasks

### Task 1: Kelly Criterion Capital Allocation (AC: 1)
- [ ] Subtask 1.1: Implement Kelly Criterion calculation engine
  - [ ] Create `calculate_kelly_fraction()` function based on win rate and average win/loss
  - [ ] Add position sizing limits (cap at 25% for safety as per PRD)
  - [ ] Integrate with existing fitness calculation framework
  - [ ] Add configuration parameters for Kelly Criterion in production_config.ini
- [ ] Subtask 1.2: Integrate Kelly sizing with portfolio optimization
  - [ ] Modify algorithm selection to respect Kelly position sizes
  - [ ] Update capital allocation logic in all 8 optimization algorithms
  - [ ] Add dynamic leverage calculation based on Kelly fractions
  - [ ] Create fallback to equal weighting when Kelly suggests zero allocation
- [ ] Subtask 1.3: Implement Kelly Criterion validation
  - [ ] Test with historical win/loss data from production datasets
  - [ ] Validate position sizing against risk limits
  - [ ] Ensure total portfolio allocation stays within capital constraints
  - [ ] Add logging for Kelly Criterion decisions

### Task 2: VaR/CVaR Risk Metrics Implementation (AC: 2)
- [ ] Subtask 2.1: Create VaR/CVaR calculation framework
  - [ ] Implement Value at Risk (VaR) at 95% and 99% confidence levels
  - [ ] Add Conditional Value at Risk (CVaR) calculations
  - [ ] Use cuDF for GPU-accelerated risk calculations
  - [ ] Support both historical and parametric VaR methods
- [ ] Subtask 2.2: Integrate risk metrics into optimization constraints
  - [ ] Add VaR limits as hard constraints in optimization
  - [ ] Implement CVaR-based portfolio rebalancing
  - [ ] Create risk budget allocation per strategy
  - [ ] Add risk contribution analysis for portfolio components
- [ ] Subtask 2.3: Risk reporting and monitoring
  - [ ] Add VaR/CVaR metrics to output generation engine
  - [ ] Create risk attribution reports by strategy
  - [ ] Implement real-time risk monitoring during optimization
  - [ ] Add risk limit breach alerting

### Task 3: Advanced Return Metrics (AC: 3)
- [ ] Subtask 3.1: Implement Sharpe Ratio optimization
  - [ ] Calculate risk-adjusted returns using standard deviation
  - [ ] Add annualized Sharpe ratio calculations
  - [ ] Integrate Sharpe optimization into fitness functions
  - [ ] Support custom risk-free rate configuration
- [ ] Subtask 3.2: Implement Sortino Ratio for downside focus
  - [ ] Calculate downside deviation (negative returns only)
  - [ ] Add Sortino ratio as alternative to Sharpe
  - [ ] Create configuration for Sharpe vs Sortino preference
  - [ ] Implement minimum acceptable return (MAR) parameter
- [ ] Subtask 3.3: Implement Calmar Ratio for drawdown analysis
  - [ ] Calculate Calmar ratio (return/max drawdown)
  - [ ] Integrate with existing drawdown calculations
  - [ ] Add rolling Calmar ratio analysis
  - [ ] Create drawdown-based position sizing

### Task 4: Market Regime Optimization (AC: 4)
- [ ] Subtask 4.1: Implement regime confidence-based selection
  - [ ] Use Regime_Confidence_% column for strategy filtering
  - [ ] Only select strategies with confidence > threshold (default 70%)
  - [ ] Create regime-specific portfolio compositions
  - [ ] Add transition logic for regime uncertainty periods
- [ ] Subtask 4.2: Dynamic position sizing by regime confidence
  - [ ] Scale position sizes by confidence scores (0-100%)
  - [ ] Implement regime_weight = Regime_Confidence_% / 100.0
  - [ ] Add configuration for minimum confidence thresholds
  - [ ] Create regime-based capital allocation rules
- [ ] Subtask 4.3: Market regime transition handling
  - [ ] Use Market_regime_transition_threshold for detection
  - [ ] Reduce positions during transition periods
  - [ ] Implement regime-specific risk limits
  - [ ] Add regime analysis to output reports

### Task 5: Enhanced Fitness Function Integration
- [ ] Subtask 5.1: Create configurable fitness modes
  - [ ] Implement legacy mode: roi/drawdown - penalty (backward compatible)
  - [ ] Add enhanced mode: kelly_weight * sharpe * regime_factor - var_penalty
  - [ ] Create hybrid mode combining both approaches
  - [ ] Add configuration in production_config.ini for mode selection
- [ ] Subtask 5.2: Update all algorithms with enhanced fitness
  - [ ] Modify GA to use enhanced fitness calculations
  - [ ] Update PSO, SA, DE, ACO, HC, BO, RS algorithms
  - [ ] Ensure backward compatibility with legacy fitness
  - [ ] Add performance comparison between modes
- [ ] Subtask 5.3: Configuration and testing
  - [ ] Create comprehensive configuration section for financial metrics
  - [ ] Add unit tests for all new financial calculations
  - [ ] Validate enhanced metrics with production data
  - [ ] Document configuration options and best practices

## Dev Notes

### Previous Story Context
This story builds upon the completed Parquet/Arrow/cuDF migration (Story 1.5) and integrates with the existing algorithm framework from Stories 1.1-1.4.

**Dependencies:**
- Story 1.1: Real algorithm integration provides the optimization framework
- Story 1.4: ULTA enhancement provides strategy performance data for Kelly Criterion
- Story 1.5: Parquet/Arrow/cuDF provides the data pipeline for efficient calculations

### Data Models

**Enhanced Configuration Schema**:
```ini
[FITNESS_CALCULATION]
mode = enhanced  # legacy|enhanced|hybrid
legacy_metrics = roi,dd,ratio
enhanced_metrics = sharpe,sortino,calmar,kelly

[KELLY_CRITERION]
enabled = true
max_position_size = 0.25  # 25% cap for safety
min_position_size = 0.01  # 1% minimum
fallback_mode = equal_weight

[RISK_METRICS]
var_confidence_levels = 95,99
cvar_confidence_levels = 95,99
var_limit = 0.025  # 2.5% daily VaR limit
risk_free_rate = 0.02  # 2% annualized

[MARKET_REGIME_CONFIG]
regime_column = market_regime
confidence_column = Regime_Confidence_%
min_confidence_threshold = 70
confidence_weighting = true
regime_specific_portfolios = true
```

### API Specifications

**Financial Metrics Interface**:
```python
# Kelly Criterion
def calculate_kelly_fraction(win_rate: float, avg_win: float, avg_loss: float) -> float

# VaR/CVaR
def calculate_var(returns: cudf.Series, confidence: float = 0.95) -> float
def calculate_cvar(returns: cudf.Series, confidence: float = 0.95) -> float

# Risk-adjusted returns
def calculate_sharpe_ratio(returns: cudf.Series, risk_free_rate: float = 0.02) -> float
def calculate_sortino_ratio(returns: cudf.Series, mar: float = 0.0) -> float
def calculate_calmar_ratio(returns: cudf.Series, max_dd: float) -> float

# Market regime
def apply_regime_confidence_weighting(strategies: cudf.DataFrame, 
                                    min_confidence: float = 0.7) -> cudf.DataFrame
```

### Component Specifications

**Enhanced Financial Metrics Module**:
- Location: `/backend/lib/financial_metrics/enhanced_metrics.py`
- GPU-accelerated calculations using cuDF
- Integration with existing fitness calculation framework
- Configurable metric selection and weighting

**Risk Management Engine**:
- Location: `/backend/lib/risk_management/var_cvar_calculator.py`
- Real-time risk calculation during optimization
- Portfolio-level and strategy-level risk metrics
- Risk budget enforcement and monitoring

**Market Regime Optimizer**:
- Location: `/backend/lib/regime_optimization/regime_handler.py`
- Confidence-based strategy filtering and weighting
- Regime transition detection and handling
- Dynamic position sizing based on regime confidence

### File Locations

**New Components**:
- Enhanced metrics: `/backend/lib/financial_metrics/enhanced_metrics.py`
- Kelly Criterion: `/backend/lib/financial_metrics/kelly_criterion.py`
- VaR/CVaR engine: `/backend/lib/risk_management/var_cvar_calculator.py`
- Regime optimizer: `/backend/lib/regime_optimization/regime_handler.py`

**Modified Components**:
- Main workflow: `/backend/parquet_cudf_workflow.py` (add enhanced metrics integration)
- Fitness calculation: Update to support configurable modes
- Algorithm implementations: Integrate enhanced fitness functions
- Output engine: Add new metrics to reports

### Testing Requirements

**Unit Tests**:
- Kelly Criterion calculations with various win/loss scenarios
- VaR/CVaR accuracy validation against known distributions
- Sharpe/Sortino/Calmar ratio calculations
- Market regime confidence weighting logic

**Integration Tests**:
- End-to-end workflow with enhanced metrics enabled
- Performance comparison: legacy vs enhanced fitness modes
- Risk constraint enforcement during optimization
- Regime-based portfolio composition

**Performance Validation**:
- Enhanced metrics should add <20% overhead to optimization time
- GPU acceleration for all financial calculations
- Memory efficiency with large portfolios (100k+ strategies)

### Technical Constraints

**PRD Compliance**:
- Kelly Criterion with 25% position size cap [PRD Section 4]
- VaR/CVaR at 95% and 99% confidence levels [PRD Section 4]
- Market regime optimization with configurable thresholds [PRD Section 4]
- Backward compatibility with legacy fitness mode [Architecture Section 4]

**Performance Requirements**:
- Maintain <3 second end-to-end processing for standard datasets
- GPU-accelerated calculations for all metrics
- Efficient memory usage for correlation + risk calculations
- Real-time risk monitoring without blocking optimization

## Change Log
| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-08-03 | 1.0 | Initial story creation based on PRD Section 4 requirements | Claude Code |

## Dev Agent Record

### Agent Model Used
[To be filled by Dev Agent]

### Debug Log References
[To be updated during implementation]

### Completion Notes List
[To be updated during implementation]

### File List
[To be updated during implementation]

## QA Results

### QA Review Summary
[To be completed by QA Agent after implementation]

### Acceptance Criteria Verification
[To be completed by QA Agent]

### Test Results
[To be completed by QA Agent]

### Code Quality Assessment
[To be completed by QA Agent]

### Issues Found
[To be completed by QA Agent]

### Compliance Check
[To be completed by QA Agent]

### Final QA Verdict
[To be completed by QA Agent]